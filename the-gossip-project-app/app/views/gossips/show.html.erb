<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card shadow-lg border-0 rounded-4">

        <!-- HEADER -->
        <div class="card-header" style="background-color: #FF9F43; color: white;">
          <h2 class="mb-0 fw-bold"><%= @gossip.title %></h2>
        </div>

        <div class="card-body p-4">

          <!-- Auteur -->
          <p class="mb-2">
            <span class="badge rounded-pill px-3 py-2" style="background-color: #FFD2A6; color: #333;">
              Auteur : <%= link_to @gossip.user.first_name, user_path(@gossip.user.id), class: "text-decoration-none text-dark" %>
            </span>
          </p>

          <!-- Date + Ville -->
          <div class="d-flex align-items-center gap-3 text-muted small mb-3">
            <span>Cr√©√© le <%= @gossip.created_at.strftime("%d %B %Y") %></span>
            <% if @gossip.user&.city %>
              <span class="border rounded-pill px-2 py-1 text-secondary bg-light">
                üìç <%= link_to @gossip.user.city.name, city_path(@gossip.user.city.id), class: "text-decoration-none text-secondary" %>
              </span>
            <% end %>
          </div>

          <!-- Tags -->
          <div class="mb-3">
            <% @gossip.tags.each do |tag| %>
              <span class="badge me-1" style="background-color: <%= tag.color %>;"><%= tag.title %></span>
            <% end %>
          </div>

          <!-- Contenu -->
          <p class="lead" style="line-height: 1.7;"><%= @gossip.content %></p>

          <!-- Likes Gossip -->
          <div class="mb-3 d-flex gap-2 align-items-center">
            <% if current_user %>
              <% like = current_user.likes.find_by(likeable: @gossip) %>
              <% if like %>
                <%= button_to "‚ù§Ô∏è Unlike", gossip_like_path(@gossip, like),
                      method: :delete,
                      class: "btn btn-sm btn-outline-danger rounded-pill" %>
              <% else %>
                <%= button_to "ü§ç Like", gossip_likes_path(@gossip),
                      method: :post,
                      class: "btn btn-sm btn-outline-primary rounded-pill" %>
              <% end %>
            <% end %>
            <span class="small text-muted"><%= @gossip.likes.count %> likes</span>
          </div>

        </div>

        <!-- FOOTER ACTIONS -->
        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
          <%= link_to "‚Üê Retour", root_path, class: "btn btn-outline-secondary rounded-pill px-4" %>

          <% if current_user == @gossip.user %>
            <div class="d-flex gap-2">
              <%= link_to edit_gossip_path(@gossip),
                  class: "btn rounded-pill px-4 fw-semibold",
                  style: "background-color: #FFB347; border: none; color: white;" do %>
                ‚úèÔ∏è Modifier
              <% end %>

              <%= button_to gossip_path(@gossip),
                  method: :delete,
                  class: "btn btn-danger rounded-pill px-4 fw-semibold",
                  form: { data: { turbo_confirm: "Tu es s√ªr de vouloir supprimer ce potin ?" } } do %>
                üóëÔ∏è Supprimer
              <% end %>
            </div>
          <% end %>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ================== COMMENTAIRES ================== -->
<div class="container mt-5">
  <div class="comment-section">

<div class="flex-grow-1">
  <%= form_with model: @comment, url: gossip_comments_path(@gossip), local: true do |f| %>
    <%= f.text_area :content, class: "form-control", rows: 3, placeholder: "√âcris un commentaire..." %>
    <div class="mt-3 text-end">
      <%= f.submit "Publier", class: "btn btn-primary rounded-pill px-4" %>
    </div>
  <% end %>
</div>

    <!-- Liste des commentaires -->
    <div class="comments-list">
      <% @comments.each do |comment| %>
        <div class="card mb-3 border-0 shadow-sm rounded-4 p-3 position-relative">

          <div class="d-flex gap-3 align-items-start">
            <img src="https://i.pravatar.cc/60?u=<%= comment.user.email %>"
                alt="avatar"
                class="rounded-circle flex-shrink-0"
                width="50" height="50"
                style="object-fit: cover;">

            <div class="flex-grow-1">

              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong><%= comment.user&.first_name || "Anonyme" %></strong>
                <small class="text-muted"><%= comment.created_at.strftime("%d %B %Y, %H:%M") %></small>
              </div>

              <p><%= comment.content %></p>

              <!-- Boutons R√©pondre + Like au-dessus du champ de r√©ponse -->
              <% if current_user %>
                <div class="d-flex gap-2 mb-2 align-items-center">
                  <% like = current_user.likes.find_by(likeable: comment) %>
                  <% if like %>
                    <%= button_to "‚ù§Ô∏è Unlike", gossip_comment_like_path(@gossip, comment, like),
                          method: :delete,
                          class: "btn btn-sm btn-outline-danger rounded-pill" %>
                  <% else %>
                    <%= button_to "ü§ç Like", gossip_comment_likes_path(@gossip, comment),
                          method: :post,
                          class: "btn btn-sm btn-outline-primary rounded-pill" %>
                  <% end %>
                  <span class="small text-muted"><%= comment.likes.count %> likes</span>
                </div>
              <% end %>

              <!-- R√©ponse au commentaire -->
              <details class="mb-2">
                <summary class="btn btn-sm btn-outline-secondary rounded-pill">
                  R√©pondre
                </summary>
                <div class="mt-2">
                  <%= form_with model: Comment.new, url: gossip_comments_path(@gossip), local: true, html: { class: "d-flex gap-2 align-items-start" } do |f| %>
                    <%= hidden_field_tag :comment_id, comment.id %>
                    <%= f.text_area :content, class: "form-control flex-grow-1", rows: 2, placeholder: "√âcris ta r√©ponse..." %>
                    <%= f.submit "Publier", class: "btn btn-sm btn-outline-primary" %>
                  <% end %>
                </div>
              </details>

              <!-- AFFICHAGE DES R√âPONSES -->
              <% comment.comments.each do |reply| %>
                <div class="card mt-2 ms-4 border-0 bg-light rounded-3 p-2 position-relative">
                  <div class="d-flex gap-2 align-items-start">
                    <img src="https://i.pravatar.cc/40?u=<%= reply.user.email %>"
                        class="rounded-circle flex-shrink-0"
                        width="35" height="35"
                        style="object-fit: cover;">
                    <div class="flex-grow-1">
                      <strong><%= reply.user.first_name %></strong>
                      <small class="text-muted ms-2"><%= reply.created_at.strftime("%d %B %Y, %H:%M") %></small>
                      <p class="mb-1"><%= reply.content %></p>

                      <!-- Editer + Supprimer replies sur la m√™me ligne -->
                      <% if current_user == reply.user %>
                        <div class="d-flex gap-2 mb-2">
                          <%= link_to "Editer", edit_gossip_comment_path(@gossip, reply),
                              class: "btn btn-sm btn-outline-secondary rounded-pill" %>
                          <%= button_to gossip_comment_path(@gossip, reply),
                              method: :delete,
                              class: "btn btn-sm btn-danger rounded-pill",
                              form: { data: { turbo_confirm: "Supprimer ce commentaire ?" } } do %>
                            Supprimer
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>

            </div>

            <!-- Bouton Supprimer commentaire principal -->
            <% if current_user == comment.user %>
              <div class="position-absolute" style="bottom: 10px; right: 10px;">
                <%= button_to gossip_comment_path(@gossip, comment),
                    method: :delete,
                    class: "btn btn-sm btn-danger rounded-pill",
                    form: { data: { turbo_confirm: "Supprimer ce commentaire ?" } } do %>
                  Supprimer
                <% end %>
              </div>
            <% end %>

          </div>
        </div>
      <% end %>
    </div>

  </div>
</div>